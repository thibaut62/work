<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcul des Heures de Travail</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            height: 400px;
        }
        .mois-container {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 15px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .calendrier-mois {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .calendrier-mois th, .calendrier-mois td {
            width: 14.28%;
            height: 32px;
            border: 1px solid #e2e8f0;
            padding: 3px;
            text-align: center;
            vertical-align: top;
            font-size: 0.75rem;
        }
        .calendrier-mois th {
            background-color: #f8fafc;
            font-weight: bold;
        }
        .jour-travaille {
            background-color: #dbeafe;
        }
        .entree-jour {
            display: block;
            font-size: 0.65rem;
            color: #3b82f6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .today {
            background-color: #fef3c7;
            font-weight: bold;
        }
        .autre-mois {
            color: #cbd5e1;
        }
        .error {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-blue-600 text-center mb-8">Calcul des Heures de Travail</h1>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Navigation -->
            <div class="lg:col-span-1">
                <div class="bg-white shadow-md rounded-lg p-4 mb-6 sticky top-4">
                    <nav>
                        <ul>
                            <li class="mb-2">
                                <a href="#feuille1" class="block px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-md font-medium">Saisie des Données</a>
                            </li>
                            <li class="mb-2">
                                <a href="#feuille2" class="block px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-md font-medium">Calendrier</a>
                            </li>
                            <li class="mb-2">
                                <a href="#feuille3" class="block px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-md font-medium">Graphiques</a>
                            </li>
                        </ul>
                    </nav>
                    
                    <div class="mt-8 border-t pt-4">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Sélection de période</h3>
                        <div class="mb-3">
                            <label for="selectMois" class="block text-gray-700 text-xs font-medium mb-1">Mois :</label>
                            <select id="selectMois" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                                <option value="0">Janvier</option>
                                <option value="1">Février</option>
                                <option value="2">Mars</option>
                                <option value="3">Avril</option>
                                <option value="4">Mai</option>
                                <option value="5">Juin</option>
                                <option value="6">Juillet</option>
                                <option value="7">Août</option>
                                <option value="8">Septembre</option>
                                <option value="9">Octobre</option>
                                <option value="10">Novembre</option>
                                <option value="11">Décembre</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="selectAnnee" class="block text-gray-700 text-xs font-medium mb-1">Année :</label>
                            <select id="selectAnnee" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                            </select>
                        </div>
                        <button id="appliquerFiltre" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white text-sm py-1.5 px-3 rounded-md">Appliquer</button>
                    </div>
                    
                    <div class="mt-8 border-t pt-4">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Gestion des données</h3>
                        <div class="flex flex-col space-y-2">
                            <button id="enregistrerFichier" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                                </svg>
                                Exporter les données
                            </button>
                            <button id="chargerFichier" class="bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-3 rounded-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Importer des données
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenu principal -->
            <div class="lg:col-span-4">
                <div id="feuille1" class="bg-white shadow-md rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Saisie des Données
                    </h2>

                    <form id="formEntree" class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="dateTravail" class="block text-gray-700 text-sm font-medium mb-1">Date de travail :</label>
                                <input type="date" id="dateTravail" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                                <div id="dateError" class="error hidden">Veuillez sélectionner une date.</div>
                            </div>
                            <div>
                                <label for="heureDebut" class="block text-gray-700 text-sm font-medium mb-1">Heure de début :</label>
                                <input type="time" id="heureDebut" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                                <div id="heureDebutError" class="error hidden">Veuillez sélectionner une heure de début.</div>
                            </div>
                            <div>
                                <label for="heureFin" class="block text-gray-700 text-sm font-medium mb-1">Heure de fin :</label>
                                <input type="time" id="heureFin" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
                                <div id="heureFinError" class="error hidden">Veuillez sélectionner une heure de fin.</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="pauseDejeuner" class="block text-gray-700 text-sm font-medium mb-1">Pause déjeuner (minutes) :</label>
                                <input type="number" id="pauseDejeuner" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border" value="30" min="0" max="180">
                            </div>
                            <div class="md:col-span-2">
                                <label for="commentaire" class="block text-gray-700 text-sm font-medium mb-1">Commentaire (optionnel) :</label>
                                <input type="text" id="commentaire" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border" placeholder="Description du travail effectué...">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" id="ajouterEntree" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Ajouter Entrée
                            </button>
                        </div>
                    </form>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Entrées récentes
                        </h3>
                        <div id="tableauEntrees" class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Début</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fin</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durée</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commentaire</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tableauEntreesBody" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="6" class="px-4 py-4 text-sm text-gray-500 text-center">Aucune entrée ajoutée.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Résumé des heures travaillées
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <h4 class="text-sm font-medium text-blue-800 mb-2">Cette semaine</h4>
                                <p id="totalSemaine" class="text-xl font-semibold text-blue-900">0 heures 0 minutes</p>
                                <p id="moyenneSemaine" class="text-xs text-blue-600 mt-1">Moyenne: 0h / jour</p>
                                <div class="mt-2 pt-2 border-t border-blue-200">
                                    <p class="text-sm font-medium text-blue-800">Heures supplémentaires :</p>
                                    <p id="suppSemaine" class="text-sm font-semibold text-red-600">0 heures 0 minutes</p>
                                </div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                                <h4 class="text-sm font-medium text-purple-800 mb-2">Ce mois</h4>
                                <p id="totalMois" class="text-xl font-semibold text-purple-900">0 heures 0 minutes</p>
                                <p id="joursTravaillesMois" class="text-xs text-purple-600 mt-1">0 jours travaillés</p>
                                <div class="mt-2 pt-2 border-t border-purple-200">
                                    <p class="text-sm font-medium text-purple-800">Heures supplémentaires :</p>
                                    <p id="suppMois" class="text-sm font-semibold text-red-600">0 heures 0 minutes</p>
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                <h4 class="text-sm font-medium text-green-800 mb-2">Cette année</h4>
                                <p id="totalAnnee" class="text-xl font-semibold text-green-900">0 heures 0 minutes</p>
                                <p id="joursTravaillesAnnee" class="text-xs text-green-600 mt-1">0 jours travaillés</p>
                                <div class="mt-2 pt-2 border-t border-green-200">
                                    <p class="text-sm font-medium text-green-800">Heures supplémentaires :</p>
                                    <p id="suppAnnee" class="text-sm font-semibold text-red-600">0 heures 0 minutes</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="feuille2" class="bg-white shadow-md rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Calendrier
                        <span id="periodeCalendrier" class="ml-2 text-sm font-normal text-gray-500"></span>
                    </h2>
                    <div id="calendrierAnnuel" class="grid gap-4 grid-cols-1 md:grid-cols-3">
                        <!-- Calendrier dynamique ici -->
                    </div>
                </div>

                <div id="feuille3" class="bg-white shadow-md rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Graphiques
                        <span id="periodeGraphique" class="ml-2 text-sm font-normal text-gray-500"></span>
                    </h2>
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Heures travaillées par mois</h3>
                        <div class="chart-container">
                            <canvas id="graphiqueHeuresAnnuelles"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Répartition hebdomadaire</h3>
                        <div class="chart-container">
                            <canvas id="graphiqueJoursHebdo"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div id="modalConfirmation" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-md mx-auto p-6 shadow-xl">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Confirmation</h3>
            <p class="text-gray-700 mb-6">Êtes-vous sûr de vouloir supprimer cette entrée ?</p>
            <div class="flex justify-end space-x-3">
                <button id="annulerSuppression" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md">Annuler</button>
                <button id="confirmerSuppression" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Notification toast -->
    <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-3 rounded-md shadow-lg transform transition-transform duration-300 translate-y-20 opacity-0 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <span id="notificationMessage">Opération réussie</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            HEURES_TRAVAIL_PAR_SEMAINE: 35,  // Nombre d'heures de travail standard par semaine
            JOURS_TRAVAIL_PAR_SEMAINE: 5,    // Nombre de jours de travail standard par semaine
            DEBUT_SEMAINE: 1,                // 0 = Dimanche, 1 = Lundi
            FORMAT_DATE: {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            },
            FORMAT_HEURE: {
                hour: '2-digit',
                minute: '2-digit'
            },
            STORAGE_KEY: 'heuresTravailData',
            COULEUR_PRIMAIRE: '#3b82f6',     // Bleu
            COULEURS_MOIS: [
                'rgba(59, 130, 246, 0.7)',   // Bleu
                'rgba(99, 102, 241, 0.7)',   // Indigo
                'rgba(139, 92, 246, 0.7)',   // Violet
                'rgba(236, 72, 153, 0.7)',   // Rose
                'rgba(239, 68, 68, 0.7)',    // Rouge
                'rgba(249, 115, 22, 0.7)',   // Orange
                'rgba(245, 158, 11, 0.7)',   // Ambre
                'rgba(16, 185, 129, 0.7)',   // Emeraude
                'rgba(5, 150, 105, 0.7)',    // Vert
                'rgba(14, 165, 233, 0.7)',   // Bleu ciel
                'rgba(6, 182, 212, 0.7)',    // Cyan
                'rgba(107, 114, 128, 0.7)'   // Gris
            ]
        };

        // Récupération des éléments HTML
        const elements = {
            // Formulaire
            form: document.getElementById('formEntree'),
            dateTravail: document.getElementById('dateTravail'),
            heureDebut: document.getElementById('heureDebut'),
            heureFin: document.getElementById('heureFin'),
            pauseDejeuner: document.getElementById('pauseDejeuner'),
            commentaire: document.getElementById('commentaire'),
            ajouterEntreeBtn: document.getElementById('ajouterEntree'),
            
            // Erreurs
            dateError: document.getElementById('dateError'),
            heureDebutError: document.getElementById('heureDebutError'),
            heureFinError: document.getElementById('heureFinError'),
            
            // Tableau des entrées
            tableauEntrees: document.getElementById('tableauEntreesBody'),
            
            // Résumés
            totalSemaine: document.getElementById('totalSemaine'),
            totalMois: document.getElementById('totalMois'),
            totalAnnee: document.getElementById('totalAnnee'),
            suppSemaine: document.getElementById('suppSemaine'),
            suppMois: document.getElementById('suppMois'),
            suppAnnee: document.getElementById('suppAnnee'),
            joursTravaillesMois: document.getElementById('joursTravaillesMois'),
            joursTravaillesAnnee: document.getElementById('joursTravaillesAnnee'),
            moyenneSemaine: document.getElementById('moyenneSemaine'),
            
            // Calendrier
            calendrierAnnuel: document.getElementById('calendrierAnnuel'),
            periodeCalendrier: document.getElementById('periodeCalendrier'),
            
            // Sélecteurs de date
            selectMois: document.getElementById('selectMois'),
            selectAnnee: document.getElementById('selectAnnee'),
            appliquerFiltre: document.getElementById('appliquerFiltre'),
            
            // Graphiques
            graphiqueHeuresAnnuelles: document.getElementById('graphiqueHeuresAnnuelles'),
            graphiqueJoursHebdo: document.getElementById('graphiqueJoursHebdo'),
            periodeGraphique: document.getElementById('periodeGraphique'),
            
            // Boutons de fichier
            enregistrerFichier: document.getElementById('enregistrerFichier'),
            chargerFichier: document.getElementById('chargerFichier'),
            
            // Modal de confirmation
            modalConfirmation: document.getElementById('modalConfirmation'),
            annulerSuppression: document.getElementById('annulerSuppression'),
            confirmerSuppression: document.getElementById('confirmerSuppression'),
            
            // Notification
            notification: document.getElementById('notification'),
            notificationMessage: document.getElementById('notificationMessage')
        };

        // État de l'application
        const state = {
            entrees: [],
            dateActuelle: new Date(),
            moisSelectionne: new Date().getMonth(),
            anneeSelectionnee: new Date().getFullYear(),
            indexASupprimer: null,
            charts: {
                heuresAnnuelles: null,
                joursHebdo: null
            }
        };

// Constantes pour les noms des jours et des mois
const JOURS_SEMAINE = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
const MOIS = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

// Initialisation de l'application
function initialiserApp() {
    // Initialisation des sélecteurs d'année
    initialiserSelecteurAnnee();
    
    // Définir la date du jour dans le formulaire
    const aujourdHui = new Date();
    elements.dateTravail.value = formatDatePourInput(aujourdHui);
    
    // Charger les données existantes
    chargerDonnees();
    
    // Initialisation des événements
    initialiserEvenements();
    
    // Afficher les données
    afficherEntrees();
    mettreAJourResumes();
    genererCalendrier();
    genererGraphiques();
}

// Formatage des dates et heures
function formatDatePourInput(date) {
    const d = new Date(date);
    return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('fr-FR', CONFIG.FORMAT_DATE);
}

function formatHeure(heureStr) {
    if (!heureStr) return '';
    return heureStr.substring(0, 5);
}

function formatDuree(dureeEnMinutes) {
    const heures = Math.floor(dureeEnMinutes / 60);
    const minutes = dureeEnMinutes % 60;
    return `${heures} heure${heures > 1 ? 's' : ''} ${minutes} minute${minutes > 1 ? 's' : ''}`;
}

// Gestion des données
function chargerDonnees() {
    const donneesSauvegardees = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (donneesSauvegardees) {
        try {
            state.entrees = JSON.parse(donneesSauvegardees);
            // Convertir les chaînes de date en objets Date
            state.entrees.forEach(entree => {
                entree.date = new Date(entree.date);
            });
        } catch (e) {
            console.error('Erreur lors du chargement des données :', e);
            state.entrees = [];
        }
    }
}

function sauvegarderDonnees() {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.entrees));
}

// Calcul des durées
function calculerDureeEnMinutes(heureDebut, heureFin, pauseEnMinutes) {
    const [debutHeures, debutMinutes] = heureDebut.split(':').map(Number);
    const [finHeures, finMinutes] = heureFin.split(':').map(Number);
    
    let dureeEnMinutes = (finHeures * 60 + finMinutes) - (debutHeures * 60 + debutMinutes);
    dureeEnMinutes -= pauseEnMinutes;
    
    return Math.max(0, dureeEnMinutes);
}

// Gestion des entrées
function ajouterEntree(event) {
    event.preventDefault();
    
    // Validation des champs
    let valide = true;
    
    if (!elements.dateTravail.value) {
        elements.dateError.classList.remove('hidden');
        valide = false;
    } else {
        elements.dateError.classList.add('hidden');
    }
    
    if (!elements.heureDebut.value) {
        elements.heureDebutError.classList.remove('hidden');
        valide = false;
    } else {
        elements.heureDebutError.classList.add('hidden');
    }
    
    if (!elements.heureFin.value) {
        elements.heureFinError.classList.remove('hidden');
        valide = false;
    } else {
        elements.heureFinError.classList.add('hidden');
    }
    
    if (!valide) return;
    
    // Calcul de la durée
    const pauseDejeuner = parseInt(elements.pauseDejeuner.value) || 0;
    const duree = calculerDureeEnMinutes(elements.heureDebut.value, elements.heureFin.value, pauseDejeuner);
    
    // Création de l'entrée
    const nouvelleEntree = {
        id: Date.now().toString(),
        date: new Date(elements.dateTravail.value),
        heureDebut: elements.heureDebut.value,
        heureFin: elements.heureFin.value,
        pauseDejeuner: pauseDejeuner,
        duree: duree,
        commentaire: elements.commentaire.value
    };
    
    // Ajout à la liste
    state.entrees.push(nouvelleEntree);
    
    // Tri par date (plus récente en premier)
    state.entrees.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Sauvegarde
    sauvegarderDonnees();
    
    // Mise à jour de l'affichage
    afficherEntrees();
    mettreAJourResumes();
    genererCalendrier();
    genererGraphiques();
    
    // Réinitialisation du formulaire
    elements.heureDebut.value = '';
    elements.heureFin.value = '';
    elements.pauseDejeuner.value = '30';
    elements.commentaire.value = '';
    
    // Notification
    afficherNotification('Entrée ajoutée avec succès');
}

function supprimerEntree(id) {
    state.indexASupprimer = state.entrees.findIndex(entree => entree.id === id);
    
    if (state.indexASupprimer !== -1) {
        elements.modalConfirmation.classList.remove('hidden');
    }
}

function confirmerSuppression() {
    if (state.indexASupprimer !== null) {
        state.entrees.splice(state.indexASupprimer, 1);
        sauvegarderDonnees();
        
        // Mise à jour de l'affichage
        afficherEntrees();
        mettreAJourResumes();
        genererCalendrier();
        genererGraphiques();
        
        // Notification
        afficherNotification('Entrée supprimée avec succès');
    }
    
    // Réinitialiser et fermer le modal
    state.indexASupprimer = null;
    elements.modalConfirmation.classList.add('hidden');
}

// Affichage des entrées
function afficherEntrees() {
    // Filtrer les entrées par mois et année si nécessaire
    const entreesFiltrees = state.entrees.filter(entree => {
        const date = new Date(entree.date);
        return true; // Par défaut, afficher toutes les entrées
    });
    
    if (entreesFiltrees.length === 0) {
        elements.tableauEntrees.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-sm text-gray-500 text-center">Aucune entrée ajoutée.</td></tr>';
        return;
    }
    
    elements.tableauEntrees.innerHTML = '';
    
    entreesFiltrees.slice(0, 10).forEach(entree => {
        const ligne = document.createElement('tr');
        
        ligne.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-700">${formatDate(entree.date)}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${formatHeure(entree.heureDebut)}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${formatHeure(entree.heureFin)}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${formatDuree(entree.duree)}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${entree.commentaire || '-'}</td>
            <td class="px-4 py-3 text-sm text-right">
                <button class="text-red-600 hover:text-red-800" data-id="${entree.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </td>
        `;
        
        // Ajouter l'événement de suppression
        const btnSupprimer = ligne.querySelector('button');
        btnSupprimer.addEventListener('click', () => supprimerEntree(entree.id));
        
        elements.tableauEntrees.appendChild(ligne);
    });
}

// Calcul des résumés
function mettreAJourResumes() {
    const aujourdHui = new Date();
    const debutSemaine = getDebutSemaine(aujourdHui);
    const finSemaine = new Date(debutSemaine);
    finSemaine.setDate(finSemaine.getDate() + 6);
    
    const debutMois = new Date(aujourdHui.getFullYear(), aujourdHui.getMonth(), 1);
    const finMois = new Date(aujourdHui.getFullYear(), aujourdHui.getMonth() + 1, 0);
    
    const debutAnnee = new Date(aujourdHui.getFullYear(), 0, 1);
    const finAnnee = new Date(aujourdHui.getFullYear(), 11, 31);
    
    // Calcul pour la semaine
    const entreesSemaine = state.entrees.filter(entree => {
        const date = new Date(entree.date);
        return date >= debutSemaine && date <= finSemaine;
    });
    
    // Calcul pour le mois
    const entreesMois = state.entrees.filter(entree => {
        const date = new Date(entree.date);
        return date >= debutMois && date <= finMois;
    });
    
    // Calcul pour l'année
    const entreesAnnee = state.entrees.filter(entree => {
        const date = new Date(entree.date);
        return date >= debutAnnee && date <= finAnnee;
    });
    
    // Calcul des totaux
    const totalMinutesSemaine = entreesSemaine.reduce((total, entree) => total + entree.duree, 0);
    const totalMinutesMois = entreesMois.reduce((total, entree) => total + entree.duree, 0);
    const totalMinutesAnnee = entreesAnnee.reduce((total, entree) => total + entree.duree, 0);
    
    // Calcul des heures supplémentaires
    const heuresTotalesSemaine = totalMinutesSemaine / 60;
    const suppSemaine = Math.max(0, totalMinutesSemaine - (CONFIG.HEURES_TRAVAIL_PAR_SEMAINE * 60));
    
    // Mise à jour des affichages
    elements.totalSemaine.textContent = formatDuree(totalMinutesSemaine);
    elements.totalMois.textContent = formatDuree(totalMinutesMois);
    elements.totalAnnee.textContent = formatDuree(totalMinutesAnnee);
    
    elements.suppSemaine.textContent = formatDuree(suppSemaine);
    elements.suppMois.textContent = formatDuree(Math.max(0, totalMinutesMois - (CONFIG.HEURES_TRAVAIL_PAR_SEMAINE * 4 * 60)));
    elements.suppAnnee.textContent = formatDuree(Math.max(0, totalMinutesAnnee - (CONFIG.HEURES_TRAVAIL_PAR_SEMAINE * 52 * 60)));
    
    // Jours travaillés
    const joursTravaillesMois = new Set(entreesMois.map(entree => formatDatePourInput(entree.date))).size;
    const joursTravaillesAnnee = new Set(entreesAnnee.map(entree => formatDatePourInput(entree.date))).size;
    
    elements.joursTravaillesMois.textContent = `${joursTravaillesMois} jour${joursTravaillesMois > 1 ? 's' : ''} travaillé${joursTravaillesMois > 1 ? 's' : ''}`;
    elements.joursTravaillesAnnee.textContent = `${joursTravaillesAnnee} jour${joursTravaillesAnnee > 1 ? 's' : ''} travaillé${joursTravaillesAnnee > 1 ? 's' : ''}`;
    
    // Moyenne par jour
    const joursTravaillesEffectifs = entreesSemaine.length;
    const moyenneHeuresParJour = joursTravaillesEffectifs > 0 ? (totalMinutesSemaine / 60 / joursTravaillesEffectifs).toFixed(1) : 0;
    elements.moyenneSemaine.textContent = `Moyenne: ${moyenneHeuresParJour}h / jour`;
}

// Fonction pour obtenir le premier jour de la semaine
function getDebutSemaine(date) {
    const resultat = new Date(date);
    const jour = resultat.getDay();
    const diff = resultat.getDate() - jour + (jour === 0 ? -6 : 1); // Ajustement pour commencer la semaine le lundi
    resultat.setDate(diff);
    return resultat;
}

// Génération du calendrier
function genererCalendrier() {
    elements.calendrierAnnuel.innerHTML = '';
    elements.periodeCalendrier.textContent = `${MOIS[state.moisSelectionne]} ${state.anneeSelectionnee}`;
    
    // Générer le calendrier pour le mois sélectionné
    const mois = state.moisSelectionne;
    const annee = state.anneeSelectionnee;
    
    const conteneurMois = document.createElement('div');
    conteneurMois.className = 'mois-container';
    
    const titreMois = document.createElement('h3');
    titreMois.className = 'text-lg font-medium text-gray-700 mb-3';
    titreMois.textContent = `${MOIS[mois]} ${annee}`;
    conteneurMois.appendChild(titreMois);
    
    const tableau = document.createElement('table');
    tableau.className = 'calendrier-mois';
    
    // En-tête du calendrier (jours de la semaine)
    const entete = document.createElement('thead');
    const ligneEntete = document.createElement('tr');
    
    for (let i = 0; i < 7; i++) {
        const jour = (i + CONFIG.DEBUT_SEMAINE) % 7;
        const cellule = document.createElement('th');
        cellule.textContent = JOURS_SEMAINE[jour].substring(0, 3);
        ligneEntete.appendChild(cellule);
    }
    
    entete.appendChild(ligneEntete);
    tableau.appendChild(entete);
    
    // Corps du calendrier
    const corps = document.createElement('tbody');
    
    // Déterminer le premier jour du mois
    const premierJourDuMois = new Date(annee, mois, 1);
    const debutCalendrier = new Date(premierJourDuMois);
    
    // Ajuster au début de la semaine
    const jourSemaine = premierJourDuMois.getDay();
    const decalage = (jourSemaine - CONFIG.DEBUT_SEMAINE + 7) % 7;
    debutCalendrier.setDate(premierJourDuMois.getDate() - decalage);
    
    // Générer les semaines
    const aujourdHui = new Date();
    for (let semaine = 0; semaine < 6; semaine++) {
        const ligneSemaine = document.createElement('tr');
        
        for (let jour = 0; jour < 7; jour++) {
            const date = new Date(debutCalendrier);
            date.setDate(debutCalendrier.getDate() + (semaine * 7) + jour);
            
            const cellule = document.createElement('td');
            const estMoisCourant = date.getMonth() === mois;
            const estAujourdHui = date.getDate() === aujourdHui.getDate() && 
                                  date.getMonth() === aujourdHui.getMonth() && 
                                  date.getFullYear() === aujourdHui.getFullYear();
            
            if (!estMoisCourant) {
                cellule.classList.add('autre-mois');
            }
            
            if (estAujourdHui) {
                cellule.classList.add('today');
            }
            
            // Vérifier si des heures ont été enregistrées pour cette date
            const entreesJour = state.entrees.filter(entree => {
                const entreeDate = new Date(entree.date);
                return entreeDate.getDate() === date.getDate() && 
                       entreeDate.getMonth() === date.getMonth() && 
                       entreeDate.getFullYear() === date.getFullYear();
            });
            
            if (entreesJour.length > 0) {
                cellule.classList.add('jour-travaille');
                
                // Calculer le total d'heures pour ce jour
                const totalMinutes = entreesJour.reduce((total, entree) => total + entree.duree, 0);
                const heures = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                const entreeDiv = document.createElement('span');
                entreeDiv.className = 'entree-jour';
                entreeDiv.textContent = `${heures}h${minutes > 0 ? minutes : ''}`;
                
                cellule.innerHTML = date.getDate();
                cellule.appendChild(entreeDiv);
            } else {
                cellule.textContent = date.getDate();
            }
            
            ligneSemaine.appendChild(cellule);
        }
        
        corps.appendChild(ligneSemaine);
        
        // Si tous les jours de la dernière semaine sont dans le mois suivant, arrêter
        const dernierJour = new Date(debutCalendrier);
        dernierJour.setDate(debutCalendrier.getDate() + (semaine * 7) + 6);
        if (dernierJour.getMonth() > mois && dernierJour.getDate() >= 7) break;
    }
    
    tableau.appendChild(corps);
    conteneurMois.appendChild(tableau);
    elements.calendrierAnnuel.appendChild(conteneurMois);
}

// Génération des graphiques
function genererGraphiques() {
    elements.periodeGraphique.textContent = `${state.anneeSelectionnee}`;
    
    // Graphique des heures annuelles
    const donneesMensuelles = [];
    for (let mois = 0; mois < 12; mois++) {
        const debutMois = new Date(state.anneeSelectionnee, mois, 1);
        const finMois = new Date(state.anneeSelectionnee, mois + 1, 0);
        
        const entreesMois = state.entrees.filter(entree => {
            const date = new Date(entree.date);
            return date >= debutMois && date <= finMois;
        });
        
        const totalMinutes = entreesMois.reduce((total, entree) => total + entree.duree, 0);
        const totalHeures = totalMinutes / 60;
        
        donneesMensuelles.push({
            mois: MOIS[mois],
            heures: totalHeures
        });
    }
    
    // Destruction du graphique existant si nécessaire
    if (state.charts.heuresAnnuelles) {
        state.charts.heuresAnnuelles.destroy();
    }
    
    // Création du nouveau graphique
    state.charts.heuresAnnuelles = new Chart(elements.graphiqueHeuresAnnuelles, {
        type: 'bar',
        data: {
            labels: donneesMensuelles.map(d => d.mois),
            datasets: [{
                label: 'Heures travaillées',
                data: donneesMensuelles.map(d => d.heures),
                backgroundColor: CONFIG.COULEURS_MOIS,
                borderColor: CONFIG.COULEURS_MOIS.map(c => c.replace('0.7', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Heures'
                    }
                }
            }
        }
    });
    
    // Graphique de répartition hebdomadaire
    const donneesJoursSemaine = Array(7).fill(0);
    
    state.entrees.forEach(entree => {
        const date = new Date(entree.date);
        const jourSemaine = date.getDay();
        donneesJoursSemaine[jourSemaine] += entree.duree / 60;
    });
    
    // Rotation des jours pour commencer par lundi
    const joursRotation = CONFIG.DEBUT_SEMAINE;
    const joursRotated = [...donneesJoursSemaine.slice(joursRotation), ...donneesJoursSemaine.slice(0, joursRotation)];
    const joursLabels = [...JOURS_SEMAINE.slice(joursRotation), ...JOURS_SEMAINE.slice(0, joursRotation)];
    
    // Destruction du graphique existant si nécessaire
    if (state.charts.joursHebdo) {
        state.charts.joursHebdo.destroy();
    }
    
    // Création du nouveau graphique
    state.charts.joursHebdo = new Chart(elements.graphiqueJoursHebdo, {
        type: 'radar',
        data: {
            labels: joursLabels,
            datasets: [{
                label: 'Heures par jour de semaine',
                data: joursRotated,
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Initialisation du sélecteur d'année
function initialiserSelecteurAnnee() {
    const anneeActuelle = new Date().getFullYear();
    elements.selectAnnee.innerHTML = '';
    
    for (let annee = anneeActuelle - 5; annee <= anneeActuelle + 5; annee++) {
        const option = document.createElement('option');
        option.value = annee;
        option.textContent = annee;
        
        if (annee === anneeActuelle) {
            option.selected = true;
        }
        
        elements.selectAnnee.appendChild(option);
    }
    
    // Initialiser le mois actuel
    elements.selectMois.value = new Date().getMonth();
}

// Initialisation des événements
function initialiserEvenements() {
    // Ajout d'une entrée
    elements.form.addEventListener('submit', ajouterEntree);
    
    // Sélection de période
    elements.appliquerFiltre.addEventListener('click', () => {
        state.moisSelectionne = parseInt(elements.selectMois.value);
        state.anneeSelectionnee = parseInt(elements.selectAnnee.value);
        
        genererCalendrier();
        genererGraphiques();
    });
    
    // Modal de confirmation
    elements.annulerSuppression.addEventListener('click', () => {
        state.indexASupprimer = null;
        elements.modalConfirmation.classList.add('hidden');
    });
    
    elements.confirmerSuppression.addEventListener('click', confirmerSuppression);
    
    // Exportation des données
    elements.enregistrerFichier.addEventListener('click', exporterDonnees);
    
    // Importation des données
    elements.chargerFichier.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.addEventListener('change', importerDonnees);
        input.click();
    });
}

// Exportation des données
function exporterDonnees() {
    const donnees = JSON.stringify(state.entrees);
    const blob = new Blob([donnees], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `heures_travail_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    
    URL.revokeObjectURL(url);
    
    afficherNotification('Données exportées avec succès');
}

// Importation des données
function importerDonnees(event) {
    const fichier = event.target.files[0];
    
    if (!fichier) return;
    
    const lecteur = new FileReader();
    
    lecteur.onload = function(e) {
        try {
            const donnees = JSON.parse(e.target.result);
            
            if (Array.isArray(donnees)) {
                // Conversion des dates
                donnees.forEach(entree => {
                    entree.date = new Date(entree.date);
                });
                
                state.entrees = donnees;
                sauvegarderDonnees();
                
                // Mise à jour de l'affichage
                afficherEntrees();
                mettreAJourResumes();
                genererCalendrier();
                genererGraphiques();
                
                afficherNotification('Données importées avec succès');
            } else {
                throw new Error('Format de fichier invalide');
            }
        } catch (err) {
            console.error('Erreur lors de l\'importation :', err);
            afficherNotification('Erreur lors de l\'importation du fichier', true);
        }
    };
    
    lecteur.readAsText(fichier);
}

// Affichage des notifications
function afficherNotification(message, estErreur = false) {
    elements.notificationMessage.textContent = message;
    elements.notification.classList.remove('translate-y-20', 'opacity-0');
    elements.notification.classList.add('translate-y-0', 'opacity-100');
    
    if (estErreur) {
        elements.notification.classList.remove('bg-green-500');
        elements.notification.classList.add('bg-red-500');
    } else {
        elements.notification.classList.remove('bg-red-500');
        elements.notification.classList.add('bg-green-500');
    }
    
    setTimeout(() => {
        elements.notification.classList.remove('translate-y-0', 'opacity-100');
        elements.notification.classList.add('translate-y-20', 'opacity-0');
    }, 3000);
}

// Initialisation de l'application
document.addEventListener('DOMContentLoaded', initialiserApp);